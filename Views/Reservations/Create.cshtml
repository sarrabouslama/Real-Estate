@model RealEstateAdmin.Controllers.CreateReservationViewModel
@{
    ViewData["Title"] = "Réserver une visite";
    ViewData["ActivePage"] = "Properties";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-check"></i> Réserver une visite
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Informations du bien -->
                    <div class="alert alert-info">
                        <h5><i class="fas fa-home"></i> @Model.Property?.Title</h5>
                        <p class="mb-1">
                            <i class="fas fa-map-marker-alt"></i> @Model.Property?.Address
                        </p>
                        <p class="mb-0">
                            <strong>Prix:</strong> @Model.Property?.Price.ToString("N0") DT
                        </p>
                    </div>

                    <form method="post" asp-action="Create" id="reservationForm">
                        <input type="hidden" asp-for="PropertyId" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Date de réservation -->
                        <div class="mb-3">
                            <label asp-for="ReservationDate" class="form-label">
                                <i class="fas fa-calendar"></i> Date de visite
                            </label>
                            <input asp-for="ReservationDate" type="date" class="form-control"
                                   min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" id="reservationDate" />
                            <span asp-validation-for="ReservationDate" class="text-danger"></span>
                        </div>

                        <!-- Créneaux horaires disponibles -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-clock"></i> Créneau horaire disponible
                            </label>
                            <div id="timeSlotsContainer">
                                @if (Model.AvailableTimeSlots.Any())
                                {
                                    <div class="row g-2">
                                        @foreach (var slot in Model.AvailableTimeSlots)
                                        {
                                            <div class="col-6 col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="TimeSlot" value="@slot"
                                                           id="slot_@slot.Replace(":", "")" required>
                                                    <label class="form-check-label" for="slot_@slot.Replace(":", "")">
                                                        @slot
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Aucun créneau disponible pour cette date. Veuillez choisir une autre date.
                                    </div>
                                }
                            </div>
                            <span asp-validation-for="TimeSlot" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> Les créneaux affichés sont disponibles pour la date
                                sélectionnée.
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn"
                                @(Model.AvailableTimeSlots.Any() ? "" : "disabled")>
                                <i class="fas fa-check"></i> Confirmer la réservation
                            </button>
                            <a asp-controller="Properties" asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const dateInput = document.getElementById('reservationDate');
                            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
                            const submitBtn = document.getElementById('submitBtn');
                            const propertyId = @(Model.Property?.Id ?? 0);
                            const form = document.getElementById('reservationForm');

                            console.log('Reservation form initialized');

                            // Écouter la soumission du formulaire
                            form.addEventListener('submit', function (e) {
                                const selectedSlot = document.querySelector('input[name="TimeSlot"]:checked');
                                console.log('FORM SUBMITTING...');
                                console.log('Selected slot:', selectedSlot ? selectedSlot.value : 'NONE');
                                console.log('PropertyId:', document.querySelector('input[name="PropertyId"]').value);
                                console.log('Date:', dateInput.value);
                                // Ne pas empêcher la soumission - laisser faire
                            });

                            // Vérifier si le bouton est initialement désactivé
                            if (@Model.AvailableTimeSlots.Count == 0) {
                                submitBtn.disabled = true;
                            }

                            dateInput.addEventListener('change', async function () {
                                const selectedDate = this.value;
                                if (!selectedDate) return;

                                // Charger les créneaux disponibles via AJAX
                                try {
                                    const response = await fetch(`/Reservations/GetAvailableTimeSlots?propertyId=${propertyId}&date=${selectedDate}`);

                                    if (!response.ok) {
                                        throw new Error('Erreur serveur: ' + response.status);
                                    }

                                    const availableSlots = await response.json();
                                    console.log('Available slots:', availableSlots);

                                    if (availableSlots.length === 0) {
                                        timeSlotsContainer.innerHTML = `
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle"></i> 
                                                Aucun créneau disponible pour cette date. Veuillez choisir une autre date.
                                            </div>`;
                                        submitBtn.disabled = true;
                                    } else {
                                        let html = '<div class="row g-2">';
                                        availableSlots.forEach(slot => {
                                            const slotId = slot.replace(':', '');
                                            html += `
                                                <div class="col-6 col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" 
                                                               type="radio" 
                                                               name="TimeSlot" 
                                                               value="${slot}" 
                                                               id="slot_${slotId}"
                                                               required>
                                                        <label class="form-check-label" for="slot_${slotId}">
                                                            ${slot}
                                                        </label>
                                                    </div>
                                                </div>`;
                                        });
                                        html += '</div>';
                                        timeSlotsContainer.innerHTML = html;
                                        submitBtn.disabled = false;
                                    }
                                } catch (error) {
                                    console.error('Erreur lors du chargement des créneaux:', error);
                                    timeSlotsContainer.innerHTML = `
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-circle"></i> 
                                            Erreur lors du chargement des créneaux. Veuillez réessayer.
                                        </div>`;
                                    submitBtn.disabled = true;
                                }
                            });
                        });
    </script>
}