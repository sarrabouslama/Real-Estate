@model RealEstateAdmin.Controllers.ReservationsIndexViewModel
@{
    ViewData["Title"] = "Agenda des Réservations";
    ViewData["ActivePage"] = "Reservations";
}

<div class="container-fluid mt-4">
    <h2><i class="fas fa-calendar-alt"></i> Agenda des Réservations</h2>

    <!-- Token CSRF pour les requêtes AJAX -->
    @Html.AntiForgeryToken()

    @if (TempData["AdminSuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle"></i> @TempData["AdminSuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">@Model.PendingCount</h3>
                    <p class="mb-0"><i class="fas fa-clock"></i> En attente</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">@Model.AcceptedCount</h3>
                    <p class="mb-0"><i class="fas fa-check"></i> Acceptées</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">@Model.RefusedCount</h3>
                    <p class="mb-0"><i class="fas fa-times"></i> Refusées</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">@Model.TodayCount</h3>
                    <p class="mb-0"><i class="fas fa-calendar-day"></i> Aujourd'hui</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recherche Dynamique -->
    <div class="mb-3">
        <div class="input-group input-group-lg">
            <span class="input-group-text bg-white">
                <i class="fas fa-search text-primary"></i>
            </span>
            <input type="text" id="searchInput" class="form-control border-start-0" 
                   placeholder="Recherche : Bien, utilisateur, email..." 
                   value="@Model.SearchTerm" />
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                <i class="fas fa-filter"></i> Filtres
            </button>
        </div>
    </div>

    <!-- Filtres Avancés (Collapsible) -->
    <div class="collapse @(Model.StatusFilter != null || Model.DateFrom != null || Model.DateTo != null ? "show" : "")" id="filterCollapse">
        <div class="card mb-3">
            <div class="card-body">
                <form method="get" id="filterForm" class="row g-3">
                    <input type="hidden" name="SearchTerm" id="hiddenSearchTerm" value="@Model.SearchTerm" />
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-filter"></i> Statut</label>
                        <select class="form-select" name="StatusFilter">
                            <option value="">Tous</option>
                            <option value="En attente" selected="@(Model.StatusFilter == "En attente")">En attente</option>
                            <option value="Accepté" selected="@(Model.StatusFilter == "Accepté")">Acceptées</option>
                            <option value="Refusé" selected="@(Model.StatusFilter == "Refusé")">Refusées</option>
                            <option value="Annulée" selected="@(Model.StatusFilter == "Annulée")">Annulées</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-calendar"></i> Date début</label>
                        <input type="date" class="form-control" name="DateFrom" value="@Model.DateFrom?.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-calendar"></i> Date fin</label>
                        <input type="date" class="form-control" name="DateTo" value="@Model.DateTo?.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Appliquer
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Réinitialiser
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    @if (Model.Reservations.Any())
    {
        <div class="alert alert-info mb-3" id="resultsCount">
            <i class="fas fa-info-circle"></i> <strong id="countNumber">@Model.Reservations.Count</strong> réservation(s) trouvée(s)
        </div>
    }

    @if (Model.Reservations.Any())
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Heure</th>
                                <th>Bien</th>
                                <th>Utilisateur</th>
                                <th>Email</th>
                                <th>Statut</th>
                                <th>Remarque</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTableBody">
                            @{
                                var today = Model.Reservations.Where(r => r.ReservationDate.Date == DateTime.Today).ToList();
                                var upcoming = Model.Reservations.Where(r => r.ReservationDate.Date > DateTime.Today).ToList();
                                var past = Model.Reservations.Where(r => r.ReservationDate.Date < DateTime.Today).ToList();
                            }

                            <!-- AUJOURD'HUI -->
                            @if (today.Any())
                            {
                                <tr class="table fw-bold">
                                    <td colspan="8">
                                        <i class="fas fa-calendar-day"></i> <strong>Aujourd'hui (@today.Count)</strong>
                                    </td>
                                </tr>
                                @foreach (var reservation in today)
                                {
                                    var rowClass = reservation.Status switch
                                    {
                                        "Accepté" => "table-success",
                                        "En attente" => "table-warning",
                                        "Refusé" => "table-danger",
                                        "Annulée" => "table-secondary",
                                        _ => ""
                                    };

                                    <tr class="reservation-item @rowClass" 
                                        data-search="@(reservation.Property?.Title?.ToLower()) @(reservation.Property?.Address?.ToLower()) @(reservation.User?.UserName?.ToLower()) @(reservation.User?.Email?.ToLower()) @(reservation.User?.FullName?.ToLower())">
                                        <td>
                                            <i class="fas fa-calendar"></i>
                                            @reservation.ReservationDate.ToString("dd/MM/yyyy")
                                            <span class="badge bg-info ms-1">Aujourd'hui</span>
                                        </td>
                                        <td>
                                            <i class="fas fa-clock"></i>
                                            @reservation.TimeSlot.ToString(@"hh\:mm")
                                        </td>
                                        <td>
                                            <strong>@reservation.Property?.Title</strong>
                                            <br />
                                            <small class="text-muted">@reservation.Property?.Address</small>
                                        </td>
                                        <td>@reservation.User?.UserName</td>
                                        <td>
                                            <a href="mailto:@reservation.User?.Email">@reservation.User?.Email</a>
                                        </td>
                                        <td>
                                            @if (reservation.Status == "En attente")
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock"></i> En attente
                                                </span>
                                            }
                                            else if (reservation.Status == "Accepté")
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> Accepté
                                                </span>
                                            }
                                            else if (reservation.Status == "Refusé")
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times"></i> Refusé
                                                </span>
                                            }
                                            else if (reservation.Status == "Annulée")
                                            {
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-ban"></i> Annulée
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(reservation.AdminRemark))
                                            {
                                                <small>@reservation.AdminRemark</small>
                                            }
                                        </td>
                                        <td></td>
                                    </tr>
                                }
                            }

                            <!-- À VENIR -->
                            @if (upcoming.Any())
                            {
                                <tr class="table fw-bold">
                                    <td colspan="8">
                                        <i class="fas fa-arrow-right"></i> <strong>À venir (@upcoming.Count)</strong>
                                    </td>
                                </tr>
                                @foreach (var reservation in upcoming)
                                {
                                    var rowClass = reservation.Status switch
                                    {
                                        "Accepté" => "table-success",
                                        "En attente" => "table-warning",
                                        "Refusé" => "table-danger",
                                        "Annulée" => "table-secondary",
                                        _ => ""
                                    };

                                    <tr class="reservation-item @rowClass" 
                                        data-search="@(reservation.Property?.Title?.ToLower()) @(reservation.Property?.Address?.ToLower()) @(reservation.User?.UserName?.ToLower()) @(reservation.User?.Email?.ToLower()) @(reservation.User?.FullName?.ToLower())">
                                        <td>
                                            <i class="fas fa-calendar"></i>
                                            @reservation.ReservationDate.ToString("dd/MM/yyyy")
                                        </td>
                                        <td>
                                            <i class="fas fa-clock"></i>
                                            @reservation.TimeSlot.ToString(@"hh\:mm")
                                        </td>
                                        <td>
                                            <strong>@reservation.Property?.Title</strong>
                                            <br />
                                            <small class="text-muted">@reservation.Property?.Address</small>
                                        </td>
                                        <td>@reservation.User?.UserName</td>
                                        <td>
                                            <a href="mailto:@reservation.User?.Email">@reservation.User?.Email</a>
                                        </td>
                                        <td>
                                            @if (reservation.Status == "En attente")
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock"></i> En attente
                                                </span>
                                            }
                                            else if (reservation.Status == "Accepté")
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> Accepté
                                                </span>
                                            }
                                            else if (reservation.Status == "Refusé")
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times"></i> Refusé
                                                </span>
                                            }
                                            else if (reservation.Status == "Annulée")
                                            {
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-ban"></i> Annulée
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(reservation.AdminRemark))
                                            {
                                                <small>@reservation.AdminRemark</small>
                                            }
                                        </td>
                                        <td></td>
                                    </tr>
                                }
                            }

                            <!-- PASSÉES -->
                            @if (past.Any())
                            {
                                <tr class="table fw-bold">
                                    <td colspan="8">
                                        <i class="fas fa-history"></i> <strong>Passées (@past.Count)</strong>
                                    </td>
                                </tr>
                                @foreach (var reservation in past)
                                {
                                    var rowClass = reservation.Status switch
                                    {
                                        "Accepté" => "table-success",
                                        "En attente" => "table-warning",
                                        "Refusé" => "table-danger",
                                        "Annulée" => "table-secondary",
                                        _ => ""
                                    };

                                    <tr class="reservation-item @rowClass" 
                                        data-search="@(reservation.Property?.Title?.ToLower()) @(reservation.Property?.Address?.ToLower()) @(reservation.User?.UserName?.ToLower()) @(reservation.User?.Email?.ToLower()) @(reservation.User?.FullName?.ToLower())">
                                        <td>
                                            <i class="fas fa-calendar"></i>
                                            @reservation.ReservationDate.ToString("dd/MM/yyyy")
                                        </td>
                                        <td>
                                            <i class="fas fa-clock"></i>
                                            @reservation.TimeSlot.ToString(@"hh\:mm")
                                        </td>
                                        <td>
                                            <strong>@reservation.Property?.Title</strong>
                                            <br />
                                            <small class="text-muted">@reservation.Property?.Address</small>
                                        </td>
                                        <td>@reservation.User?.UserName</td>
                                        <td>
                                            <a href="mailto:@reservation.User?.Email">@reservation.User?.Email</a>
                                        </td>
                                        <td>
                                            @if (reservation.Status == "En attente")
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock"></i> En attente
                                                </span>
                                            }
                                            else if (reservation.Status == "Accepté")
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> Accepté
                                                </span>
                                            }
                                            else if (reservation.Status == "Refusé")
                                            {
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times"></i> Refusé
                                                </span>
                                            }
                                            else if (reservation.Status == "Annulée")
                                            {
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-ban"></i> Annulée
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(reservation.AdminRemark))
                                            {
                                                <small>@reservation.AdminRemark</small>
                                            }
                                        </td>
                                        <td></td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modals (en dehors du tableau) -->
        @foreach (var reservation in Model.Reservations)
        {
            <!-- Modal Accepter -->
            <div class="modal fade" id="acceptModal@(reservation.Id)" tabindex="-1" 
                 aria-labelledby="acceptModalLabel@(reservation.Id)" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="acceptModalLabel@(reservation.Id)">
                                <i class="fas fa-check"></i> Accepter la réservation
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" asp-action="Accept">
                            <div class="modal-body">
                                <input type="hidden" name="ReservationId" value="@reservation.Id" />
                                <p><strong>Bien:</strong> @reservation.Property?.Title</p>
                                <p><strong>Date:</strong> @reservation.ReservationDate.ToString("dd/MM/yyyy") à  @reservation.TimeSlot.ToString(@"hh\:mm")</p>
                                <p><strong>Client:</strong> @reservation.User?.UserName</p>
                                
                                <div class="mb-3">
                                    <label for="remarkAccept@(reservation.Id)" class="form-label">Remarque (optionnel)</label>
                                    <textarea name="AdminRemark" id="remarkAccept@(reservation.Id)" 
                                              class="form-control" rows="3" 
                                              placeholder="Ajoutez une remarque pour le client..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Accepter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Avertissement de Conflit -->
            <div class="modal fade" id="conflictModal@(reservation.Id)" tabindex="-1" 
                 aria-labelledby="conflictModalLabel@(reservation.Id)" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="conflictModalLabel@(reservation.Id)">
                                <i class="fas fa-exclamation-triangle"></i> Attention
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="conflictReservationId@(reservation.Id)" value="@reservation.Id" />
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Conflit détecté !</strong>
                            </div>
                            <p id="conflictMessage@(reservation.Id)" class="mb-3"></p>
                            <p><strong>Souhaitez-vous quand même accepter cette réservation ?</strong></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-arrow-left"></i> Annuler
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" 
                                    data-bs-toggle="modal" data-bs-target="#refuseModal@(reservation.Id)">
                                <i class="fas fa-times"></i> Refuser la réservation
                            </button>
                            <button type="button" class="btn btn-success btn-confirm-accept" 
                                    data-reservation-id="@reservation.Id">
                                <i class="fas fa-check"></i> Accepter quand même
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Refuser -->
            <div class="modal fade" id="refuseModal@(reservation.Id)" tabindex="-1" 
                 aria-labelledby="refuseModalLabel@(reservation.Id)" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="refuseModalLabel@(reservation.Id)">
                                <i class="fas fa-times"></i> Refuser la réservation
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" asp-action="Refuse">
                            <div class="modal-body">
                                <input type="hidden" name="ReservationId" value="@reservation.Id" />
                                <p><strong>Bien:</strong> @reservation.Property?.Title</p>
                                <p><strong>Date:</strong> @reservation.ReservationDate.ToString("dd/MM/yyyy") à  @reservation.TimeSlot.ToString(@"hh\:mm")</p>
                                <p><strong>Client:</strong> @reservation.User?.UserName</p>
                                
                                <div class="mb-3">
                                    <label for="remarkRefuse@(reservation.Id)" class="form-label">Raison du refus (optionnel)</label>
                                    <textarea name="AdminRemark" id="remarkRefuse@(reservation.Id)" 
                                              class="form-control" rows="3" 
                                              placeholder="Expliquez la raison du refus..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-times"></i> Refuser
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Aucune réservation enregistrée.
        </div>
    }
</div>

@section Styles {
    <style>
        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        .table-warning {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }
        .table-danger {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
    </style>
}

@section Scripts {
    <script>
        // Recherche dynamique côté client (sans rafraîchir la page)
        const searchInput = document.getElementById('searchInput');
        const hiddenSearchTerm = document.getElementById('hiddenSearchTerm');
        const reservationItems = document.querySelectorAll('.reservation-item');
        const countNumber = document.getElementById('countNumber');
        
        function filterReservations() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            let visibleCount = 0;
            
            reservationItems.forEach(function(item) {
                const searchData = item.getAttribute('data-search');
                if (searchData && searchData.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mettre à  jour le compteur
            if (countNumber) {
                countNumber.textContent = visibleCount;
            }
            
            // Garder le focus
            searchInput.focus();
        }
        
        searchInput.addEventListener('input', filterReservations);
        
        // Synchroniser la recherche avec les filtres (soumettre le formulaire pour les filtres avancés)
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            hiddenSearchTerm.value = searchInput.value;
        });

        // Gestion du check de conflit avant acceptation
        document.addEventListener('DOMContentLoaded', function() {
            // Gérer les clics sur les boutons d'acceptation
            document.querySelectorAll('.btn-accept-reservation').forEach(function(button) {
                button.addEventListener('click', function() {
                    const reservationId = this.getAttribute('data-reservation-id');
                    checkConflictAndShowModal(reservationId);
                });
            });

            // Gérer la confirmation d'acceptation depuis le modal de conflit
            document.querySelectorAll('.btn-confirm-accept').forEach(function(button) {
                button.addEventListener('click', function() {
                    const reservationId = this.getAttribute('data-reservation-id');
                    // Fermer le modal de conflit
                    const conflictModal = bootstrap.Modal.getInstance(document.getElementById('conflictModal' + reservationId));
                    if (conflictModal) {
                        conflictModal.hide();
                    }
                    // Ouvrir le modal d'acceptation normal
                    const acceptModal = new bootstrap.Modal(document.getElementById('acceptModal' + reservationId));
                    acceptModal.show();
                });
            });

            function checkConflictAndShowModal(reservationId) {
                // Afficher un indicateur de chargement
                const button = document.querySelector(`[data-reservation-id="${reservationId}"].btn-accept-reservation`);
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                // Faire une requête AJAX pour vérifier les conflits
                const formData = new FormData();
                formData.append('ReservationId', reservationId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                fetch('?handler=CheckConflict', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Restaurer le bouton
                    button.innerHTML = originalHtml;
                    button.disabled = false;

                    if (data.hasConflict) {
                        // Afficher le modal de conflit
                        document.getElementById('conflictMessage' + reservationId).textContent = data.message;
                        const conflictModal = new bootstrap.Modal(document.getElementById('conflictModal' + reservationId));
                        conflictModal.show();
                    } else {
                        // Pas de conflit, afficher le modal d'acceptation normal
                        const acceptModal = new bootstrap.Modal(document.getElementById('acceptModal' + reservationId));
                        acceptModal.show();
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                    alert('Erreur lors de la vérification des conflits.');
                });
            }
        });
    </script>
}
